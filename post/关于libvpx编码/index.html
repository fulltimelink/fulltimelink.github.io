<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>关于libvpx编码 | 旧事重提</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.101.0" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="fulltimelink">
<meta name="keywords" content="linux">
<link rel="stylesheet" type="text/css" media="screen" href="/css/normalize.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
<link rel="stylesheet" type="text/css" media="screen" href="/css/all.css" />




<meta property="og:title" content="关于libvpx编码" />
<meta property="og:description" content="过节了，加班写个踩的坑吧~
场景：
使用GPU将视频转码为webm 编码 libvpx-vp9 表现:
不使用GPU一切正常 开启autorotate 报错 关闭autorotate 不报错 但是转码超级慢(感觉GPU没毛用) 肯定先看后者,转码慢不解决,说啥都没用~
上ffmpeg codecs
DEV.LS h264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_cuvid ) (encoders: libx264 libx264rgb h264_nvenc nvenc nvenc_h264 ) DEV.L. hevc H.265 / HEVC (High Efficiency Video Coding) (decoders: hevc hevc_cuvid ) (encoders: nvenc_hevc hevc_nvenc ) DEVIL. mjpeg Motion JPEG (decoders: mjpeg mjpeg_cuvid ) DEV.L. mpeg1video MPEG-1 video (decoders: mpeg1video mpeg1_cuvid ) DEV." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://fulltimelink.github.io/post/%E5%85%B3%E4%BA%8Elibvpx%E7%BC%96%E7%A0%81/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-02T18:24:39+08:00" />
<meta property="article:modified_time" content="2022-04-02T18:24:39+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="关于libvpx编码"/>
<meta name="twitter:description" content="过节了，加班写个踩的坑吧~
场景：
使用GPU将视频转码为webm 编码 libvpx-vp9 表现:
不使用GPU一切正常 开启autorotate 报错 关闭autorotate 不报错 但是转码超级慢(感觉GPU没毛用) 肯定先看后者,转码慢不解决,说啥都没用~
上ffmpeg codecs
DEV.LS h264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_cuvid ) (encoders: libx264 libx264rgb h264_nvenc nvenc nvenc_h264 ) DEV.L. hevc H.265 / HEVC (High Efficiency Video Coding) (decoders: hevc hevc_cuvid ) (encoders: nvenc_hevc hevc_nvenc ) DEVIL. mjpeg Motion JPEG (decoders: mjpeg mjpeg_cuvid ) DEV.L. mpeg1video MPEG-1 video (decoders: mpeg1video mpeg1_cuvid ) DEV."/>

<meta itemprop="name" content="关于libvpx编码">
<meta itemprop="description" content="过节了，加班写个踩的坑吧~
场景：
使用GPU将视频转码为webm 编码 libvpx-vp9 表现:
不使用GPU一切正常 开启autorotate 报错 关闭autorotate 不报错 但是转码超级慢(感觉GPU没毛用) 肯定先看后者,转码慢不解决,说啥都没用~
上ffmpeg codecs
DEV.LS h264 H.264 / AVC / MPEG-4 AVC / MPEG-4 part 10 (decoders: h264 h264_cuvid ) (encoders: libx264 libx264rgb h264_nvenc nvenc nvenc_h264 ) DEV.L. hevc H.265 / HEVC (High Efficiency Video Coding) (decoders: hevc hevc_cuvid ) (encoders: nvenc_hevc hevc_nvenc ) DEVIL. mjpeg Motion JPEG (decoders: mjpeg mjpeg_cuvid ) DEV.L. mpeg1video MPEG-1 video (decoders: mpeg1video mpeg1_cuvid ) DEV."><meta itemprop="datePublished" content="2022-04-02T18:24:39+08:00" />
<meta itemprop="dateModified" content="2022-04-02T18:24:39+08:00" />
<meta itemprop="wordCount" content="211">
<meta itemprop="keywords" content="linux," />
</head>
<body>
<header>
<div id="titletext">
<h2 id="titleonly"><a href="https://fulltimelink.github.io/">旧事重提</a></h2>
</div>
<div id="title-social">
</div>
<div id="mainmenu">
<nav>
<ul>
<li><a href="/tags/algorithm">Algorithm</a></li>
<li><a href="/tags/go">Go</a></li>
<li><a href="/tags/h5">H5</a></li>
<li><a href="/tags/java">Java</a></li>
<li><a href="/tags/javascript">Javascript</a></li>
<li><a href="/tags/kubernetes">Kubernetes</a></li>
<li><a href="/tags/linux">Linux</a></li>
<li><a href="/tags/php">Php</a></li>
</ul>
</nav>
</div>
</header>
<main>
<div class="post">
<article>
<div class="post-header">
<div class="meta">
<div class="date">
<span class="day">02</span>
<span class="rest">Apr 2022</span>
</div>
</div>
<div class="matter">
<h1 class="title">关于libvpx编码</h1>
<p class="post-meta">
<span class="post-meta">





<i class="fas fa-user"></i>&nbsp;

fulltimelink



</span>

</p>
</div>
</div>
<div class="markdown">
<p>过节了，加班写个踩的坑吧~</p>
<ul>
<li>
<p>场景：</p>
<ul>
<li>使用GPU将视频转码为webm</li>
<li>编码 libvpx-vp9</li>
</ul>
</li>
<li>
<p>表现:</p>
<ul>
<li>不使用GPU一切正常</li>
<li>开启autorotate 报错</li>
<li>关闭autorotate 不报错 但是转码超级慢(<del>感觉GPU没毛用</del>)</li>
</ul>
</li>
</ul>
<p>肯定先看后者,转码慢不解决,说啥都没用~</p>
<p>上ffmpeg codecs</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> DEV.LS h264                 H.264 / AVC / MPEG-4 AVC / MPEG-4 part <span style="color:#ae81ff">10</span> <span style="color:#f92672">(</span>decoders: h264 h264_cuvid <span style="color:#f92672">)</span> <span style="color:#f92672">(</span>encoders: libx264 libx264rgb h264_nvenc nvenc nvenc_h264 <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEV.L. hevc                 H.265 / HEVC <span style="color:#f92672">(</span>High Efficiency Video Coding<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>decoders: hevc hevc_cuvid <span style="color:#f92672">)</span> <span style="color:#f92672">(</span>encoders: nvenc_hevc hevc_nvenc <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEVIL. mjpeg                Motion JPEG <span style="color:#f92672">(</span>decoders: mjpeg mjpeg_cuvid <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEV.L. mpeg1video           MPEG-1 video <span style="color:#f92672">(</span>decoders: mpeg1video mpeg1_cuvid <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEV.L. mpeg2video           MPEG-2 video <span style="color:#f92672">(</span>decoders: mpeg2video mpegvideo mpeg2_cuvid <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEV.L. mpeg4                MPEG-4 part <span style="color:#ae81ff">2</span> <span style="color:#f92672">(</span>decoders: mpeg4 mpeg4_cuvid <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> D.V.L. vc1                  SMPTE VC-1 <span style="color:#f92672">(</span>decoders: vc1 vc1_cuvid <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEV.L. vp8                  On2 VP8 <span style="color:#f92672">(</span>decoders: vp8 libvpx vp8_cuvid <span style="color:#f92672">)</span> <span style="color:#f92672">(</span>encoders: libvpx <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> DEV.L. vp9                  Google VP9 <span style="color:#f92672">(</span>decoders: vp9 libvpx-vp9 vp9_cuvid <span style="color:#f92672">)</span> <span style="color:#f92672">(</span>encoders: libvpx-vp9 <span style="color:#f92672">)</span>
</span></span></code></pre></div><p>vp9编码解码器都OK</p>
<p>仔细看了下和h264的区别，咦，encoder好像没有nvenc, cuvid和nvenc才是GPU的标识~</p>
<p>莫非vp9不支持显卡&hellip;</p>
<p><figure>
  <img src="/20220402/1.png" alt="vp9真不支持"  />
</figure></p>
<p>NVIDIA 全系 红叉 <em>-</em>  <del>这还转个球的码</del> 换h264 mp4吧。。。</p>
<p>上了h264_nvenc的encoder后，autorotate也正常了~</p>
<p>顺手记几个ffmpeg的操作吧</p>
<blockquote>
<p>ffmpeg 查看视频帧数 -用来计算转码进度</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>INPUT_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;input.mp4&#34;</span>
</span></span><span style="display:flex;"><span>ffprobe <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -v error <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -select_streams v:0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -count_packets <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -show_entries stream<span style="color:#f92672">=</span>nb_read_packets <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -of csv<span style="color:#f92672">=</span>p<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  $INPUT_FILE
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#ae81ff">7233</span>
</span></span></code></pre></div><p>有了总帧数，就需要获取当前转到多少帧了</p>
<p>可惜没有现成的参数去拿，但是可以通过-progress file的方式，将进度<strong>append</strong>到文件里</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ffmpeg -y -v error -progress %s -autorotate <span style="color:#ae81ff">1</span> -i  ...
</span></span></code></pre></div><p>文件内容</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>frame<span style="color:#f92672">=</span><span style="color:#ae81ff">73</span>
</span></span><span style="display:flex;"><span>fps<span style="color:#f92672">=</span>0.00
</span></span><span style="display:flex;"><span>stream_0_0_q<span style="color:#f92672">=</span>29.0
</span></span><span style="display:flex;"><span>bitrate<span style="color:#f92672">=</span>   0.1kbits/s
</span></span><span style="display:flex;"><span>total_size<span style="color:#f92672">=</span><span style="color:#ae81ff">48</span>
</span></span><span style="display:flex;"><span>out_time_us<span style="color:#f92672">=</span><span style="color:#ae81ff">3506213</span>
</span></span><span style="display:flex;"><span>out_time_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">3506213</span>
</span></span><span style="display:flex;"><span>out_time<span style="color:#f92672">=</span>00:00:03.506213
</span></span><span style="display:flex;"><span>dup_frames<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>drop_frames<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>speed<span style="color:#f92672">=</span>6.97x
</span></span><span style="display:flex;"><span>progress<span style="color:#f92672">=</span><span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">=</span><span style="color:#ae81ff">123</span>
</span></span><span style="display:flex;"><span>fps<span style="color:#f92672">=</span>119.47
</span></span><span style="display:flex;"><span>stream_0_0_q<span style="color:#f92672">=</span>29.0
</span></span><span style="display:flex;"><span>bitrate<span style="color:#f92672">=</span> 412.5kbits/s
</span></span><span style="display:flex;"><span>total_size<span style="color:#f92672">=</span><span style="color:#ae81ff">262192</span>
</span></span><span style="display:flex;"><span>out_time_us<span style="color:#f92672">=</span><span style="color:#ae81ff">5085170</span>
</span></span><span style="display:flex;"><span>out_time_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">5085170</span>
</span></span><span style="display:flex;"><span>out_time<span style="color:#f92672">=</span>00:00:05.085170
</span></span><span style="display:flex;"><span>dup_frames<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>drop_frames<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>speed<span style="color:#f92672">=</span>4.94x
</span></span><span style="display:flex;"><span>progress<span style="color:#f92672">=</span><span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>frame<span style="color:#f92672">=</span><span style="color:#ae81ff">154</span>
</span></span><span style="display:flex;"><span>fps<span style="color:#f92672">=</span>89.92
</span></span><span style="display:flex;"><span>stream_0_0_q<span style="color:#f92672">=</span>-1.0
</span></span><span style="display:flex;"><span>bitrate<span style="color:#f92672">=</span>2059.1kbits/s
</span></span><span style="display:flex;"><span>total_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1326765</span>
</span></span><span style="display:flex;"><span>out_time_us<span style="color:#f92672">=</span><span style="color:#ae81ff">5154830</span>
</span></span><span style="display:flex;"><span>out_time_ms<span style="color:#f92672">=</span><span style="color:#ae81ff">5154830</span>
</span></span><span style="display:flex;"><span>out_time<span style="color:#f92672">=</span>00:00:05.154830
</span></span><span style="display:flex;"><span>dup_frames<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>drop_frames<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>speed<span style="color:#f92672">=</span>3.01x
</span></span><span style="display:flex;"><span>progress<span style="color:#f92672">=</span>end
</span></span></code></pre></div><p>自己想办法解析到目前的frame  然后就能计算progress百分比了</p>
<hr>
<p><figure>
  <img src="/20220402.png" alt="二宝喝奶"  />
</figure></p>

</div>
<div class="tags">
<div class="taxosfloating_left">
<p>Tags</p>
</div>
<div class="termsfloating_right">
<p>
<a href="/tags/linux/">linux</a>
</p>
</div>
<div class="clearit"></div>
</div>
</article>
</div>
</main><script src="/js/dark-mode.js"></script>

</body>
</html>
